// backend/prisma/schema.prisma - ENHANCED VERSION WITH EXTERNAL ID FIX
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Event {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  text       String
  category   Category
  confidence Float
  source     String
  externalId String?  @unique  // Fix: Added this field for deduplication
  createdAt  DateTime @default(now())
  
  @@map("Event")
}

model Trend {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  category    Category
  
  // Spike metrics
  spikeScore      Float      // How many times above baseline (e.g., 2.5x)
  currentCount    Int        // Current event count in window
  baselineCount   Float      // Average baseline count
  percentIncrease Float      // Percentage increase (e.g., 150%)
  
  // Severity classification
  severity        TrendSeverity  // LOW, MEDIUM, HIGH, CRITICAL
  
  // Temporal information
  detectedAt      DateTime   @default(now())
  windowStart     DateTime   // When this trend window started
  windowEnd       DateTime   // When this trend window ended
  windowDuration  String     // e.g., "2h", "1d"
  
  // Sample data for context
  sampleTexts     String[]   // Up to 5 sample event texts
  topSources      Json       // Top sources contributing to trend: [{source: "rss:FDA", count: 15}, ...]
  
  // Historical comparison
  comparisonPeriod String    // e.g., "vs last 24h", "vs 7-day avg"
  trendDirection   String    // "surging", "spiking", "elevated", "declining"
  
  // Metadata
  createdAt       DateTime   @default(now())
  isActive        Boolean    @default(true)  // False when trend normalizes
  
  @@map("trends")
}

enum Category {
  BRAND_PERCEPTION
  SIDE_EFFECTS
  COMPETITOR_ACTIVITY
  REGULATION_POLICY
  CLINICAL_TRIALS
  MARKETING_PROMOTION
}

enum TrendSeverity {
  LOW          // 1.2x - 1.5x spike
  MEDIUM       // 1.5x - 2.0x spike
  HIGH         // 2.0x - 3.0x spike
  CRITICAL     // 3.0x+ spike
}